<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cardgarden.cardSearchcondition">

	<!-- 카드 조건조회 -->
	<select id="selectByConditions" resultMap="CardWithBenefitsMap" parameterType="map">
  SELECT c.*, cbd.cardbenefitdetail_text
  FROM Card c
  JOIN CardBenefitDetail cbd ON c.card_id = cbd.card_id
  WHERE c.card_id IN (
    SELECT cbd.card_id
    FROM CardBenefitDetail cbd
    JOIN BenefitDetail bd ON cbd.benefitdetail_id = bd.benefitdetail_id

    <where>
      <if test="selectedCategories != null and selectedCategories.size() > 0">
        bd.benefitdetail_id IN
        <foreach collection="selectedCategories" item="id" open="(" separator="," close=")">
          #{id}
        </foreach>
      </if>
      <if test="selectedbenefitCategoryId != null and selectedbenefitCategoryId.size() > 0">
        <if test="selectedCategories != null and selectedCategories.size() > 0"> OR </if>
        bd.benefitcategory_id IN
        <foreach collection="selectedbenefitCategoryId" item="cat" open="(" separator="," close=")">
          #{cat}
        </foreach>
      </if>
    </where>

    GROUP BY cbd.card_id

    <!-- 안전한 합계 계산 -->
    <bind name="detailSize" value="selectedCategories != null ? selectedCategories.size() : 0" />
    <bind name="catSize" value="selectedbenefitCategoryId != null ? selectedbenefitCategoryId.size() : 0" />
    <bind name="totalSize" value="detailSize + catSize" />

    <!-- 소카테고리 + 대카테고리 합친 만큼 모두 포함된 카드만 -->
    <if test="totalSize > 0">
      HAVING COUNT(DISTINCT
        CASE
          WHEN bd.benefitdetail_id IS NOT NULL THEN CONCAT('S', bd.benefitdetail_id)
          WHEN bd.benefitcategory_id IS NOT NULL THEN CONCAT('B', bd.benefitcategory_id)
        END
      ) = #{totalSize}
    </if>
  )

  <!-- 카드 종류 조건 -->
  <if test="selectedcardType != null and selectedcardType.size() > 0">
    AND c.card_type IN
    <foreach collection="selectedcardType" item="type" open="(" separator="," close=")">
      #{type}
    </foreach>
  </if>
</select>




		
		<select id="cardSelectByCompany" resultMap="CardWithBenefitsMap" parameterType="String">
			SELECT c.*, cbd.cardbenefitdetail_text
			  FROM Card c
			  JOIN CardBenefitDetail cbd ON c.card_id = cbd.card_id
			  where c.company =  #{company}
		</select>
		
		
		<resultMap id="CardWithBenefitsMap" type="CardConditionDTO">
		  <id property="card_id" column="card_id"/>
		  <result property="card_name" column="card_name"/>
		  <result property="company" column="company"/>
		  <result property="card_type" column="card_type"/>
		  <result property="brand" column="brand"/>
		  <result property="card_image" column="card_image"/>
		  <result property="card_url" column="card_url"/>
		  <result property="fee_domestic" column="fee_domestic"/>
		  <result property="fee_foreign" column="fee_foreign"/>
		  <result property="prev_month_cost" column="prev_month_cost"/>
		  <result property="card_like" column="card_like"/>
		  <result property="card_views" column="card_views"/>
		  <collection property="benefits" ofType="string">
		    <result column="cardbenefitdetail_text"/>
		  </collection>
		</resultMap>

</mapper>